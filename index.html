<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NOTMINE4REAL</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'><path d='M12 2L21 7V17L12 22L3 17V7L12 2Z' /><path d='M12 6L17 9V15L12 18L7 15V9L12 6' /></svg>" id="app-favicon" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&family=Playfair+Display:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet" />
    
    <!-- Tailwind CSS & Lucide Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { sans: ['var(--font-base)', 'sans-serif'], display: ['var(--font-head)', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'], },
            colors: { accent: 'var(--accent)', zinc: { 850: '#1f1f22', 900: '#18181b', 950: '#050505' }, black: '#000000', },
            animation: { 'reveal-up': 'revealUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards', 'fade-in': 'fadeIn 0.8s ease-out forwards', 'float': 'float 6s ease-in-out infinite', 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'slide-up-out': 'slideUpOut 0.8s cubic-bezier(0.7, 0, 0.3, 1) forwards', },
            keyframes: { revealUp: { '0%': { transform: 'translateY(30px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }, fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }, slideUpOut: { '0%': { transform: 'translateY(0)', opacity: '1' }, '100%': { transform: 'translateY(-100%)', opacity: '0' } } }
          }
        }
      }
    </script>
    <style>
      :root { --accent: #8b5cf6; --font-base: 'Outfit'; --font-head: 'Space Grotesk'; --text-size: 16px; --tracking: normal; --radius: 1rem; --grid-gap: 1.5rem; }
      body { background-color: #000000; color: #f4f4f5; overflow-x: hidden; transition: background-color 0.5s ease; font-size: var(--text-size); letter-spacing: var(--tracking); }
      ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #52525b; }
      .glass-panel { background: rgba(5, 5, 5, 0.6); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.05); }
      .scrollbar-hide::-webkit-scrollbar { display: none; } .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      .text-accent { color: var(--accent) !important; } .bg-accent { background-color: var(--accent) !important; } .border-accent { border-color: var(--accent) !important; } .group:hover .group-hover\:text-accent { color: var(--accent) !important; } .rounded-dynamic { border-radius: var(--radius) !important; }
      body.perf-mode .glass-panel, body.perf-mode .backdrop-blur-xl { backdrop-filter: none !important; background-color: #0a0a0a !important; }
      body.oled-mode { background-color: #000000 !important; } body.hide-scroll ::-webkit-scrollbar { display: none !important; }
      body.no-hover-fx .group:hover .hover-trigger { transform: none !important; box-shadow: none !important; border-color: rgba(255,255,255,0.05) !important; background-color: #0a0a0a !important; }
      body.compact-ui #games-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important; }
      body.blur-locked > *:not(#blur-overlay) { filter: blur(20px); pointer-events: none; user-select: none; }
      body.cursor-override * { cursor: var(--custom-cursor, default) !important; }
      .perspective-1000 { perspective: 1000px; transform-style: preserve-3d; }
      #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
      body.matrix-mode { background-color: #000 !important; color: #0f0 !important; font-family: 'Courier New', Courier, monospace !important; }
      body.matrix-mode * { border-color: #0f0 !important; color: #0f0 !important; font-family: 'Courier New', Courier, monospace !important; }
      body.matrix-mode .bg-accent, body.matrix-mode .bg-zinc-900 { background-color: #001100 !important; }
      body.matrix-mode img { filter: grayscale(100%) sepia(100%) hue-rotate(90deg) saturate(500%) !important; }
      .owner-card-glow { box-shadow: 0 0 60px var(--accent); border-color: var(--accent); }
    </style>
</head>
<body class="antialiased min-h-screen overflow-hidden bg-black text-white selection:bg-zinc-800 selection:text-white relative">

    <canvas id="bg-canvas"></canvas>

    <!-- Blur Security Overlay -->
    <div id="blur-overlay" onclick="this.classList.add('hidden')" class="fixed inset-0 z-[9999] bg-black/95 flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-300 cursor-pointer">
        <i data-lucide="lock" class="w-16 h-16 text-zinc-500 mb-6"></i>
        <h1 class="text-4xl font-display font-bold tracking-widest text-white mb-2">SYSTEM LOCKED</h1>
        <p class="font-mono text-zinc-500 text-sm">Administrator has locked your terminal.</p>
        <p class="font-mono text-zinc-600 text-[10px] mt-4">Click to attempt unlock</p>
    </div>

    <!-- Intro Launcher -->
    <div id="launcher-layer" class="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-black/80 backdrop-blur-md hidden animate-fade-in pointer-events-auto">
        <div class="text-center animate-reveal-up max-w-md px-6">
             <div class="mb-10 relative group cursor-pointer" onclick="app.launchApp()">
                <div class="absolute inset-0 bg-white/10 rounded-full blur-2xl group-hover:blur-3xl transition-all duration-700 opacity-0 group-hover:opacity-100"></div>
                <button class="relative px-12 py-6 bg-black border border-zinc-700/50 rounded-full text-2xl font-display font-extrabold text-white group-hover:bg-white group-hover:text-black transition-all duration-500 shadow-2xl flex items-center justify-center gap-4 w-full transform group-hover:scale-105">
                    <i data-lucide="power" class="w-6 h-6"></i><span>INITIALIZE</span>
                </button>
             </div>
             <button onclick="app.runIntro()" class="text-zinc-600 hover:text-white text-[10px] uppercase tracking-wider underline decoration-zinc-800 transition-all duration-300">Run in current window</button>
        </div>
    </div>

    <!-- Account Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-[9999] bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center pointer-events-auto transition-opacity duration-500 hidden opacity-0">
        <div class="bg-[#0a0a0a] border border-white/10 p-10 rounded-[2rem] shadow-2xl max-w-md w-full text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-accent"></div>
            <h3 class="font-display text-4xl font-black text-white mb-2">Cloud Account</h3>
            <p class="text-zinc-400 font-sans text-sm mb-8">Create an account or login to access Chat and Cloud features.</p>
            <form onsubmit="accountSystem.authenticate(event)" class="flex flex-col gap-4">
                <input type="text" id="auth-user" required maxlength="20" placeholder="Username" autocomplete="off" class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent transition-colors font-bold">
                <input type="password" id="auth-pass" required placeholder="Password / PIN" autocomplete="off" class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent transition-colors font-bold mb-2">
                <button type="submit" id="auth-btn" class="w-full py-4 bg-accent text-white font-black uppercase tracking-widest rounded-xl hover:bg-accent/80 transition-colors shadow-[0_0_20px_var(--accent)]">Login / Create</button>
                <button type="button" onclick="document.getElementById('auth-modal').classList.add('opacity-0', 'pointer-events-none'); setTimeout(()=>document.getElementById('auth-modal').classList.add('hidden'), 500);" class="text-zinc-500 hover:text-white text-xs underline mt-2">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Cutscene Layer -->
    <div id="cutscene-layer" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center overflow-hidden hidden pointer-events-none">
        <div id="cs-logo" class="relative z-10 text-center hidden">
            <div class="inline-flex items-center justify-center w-24 h-24 bg-zinc-900 rounded-3xl mb-10 shadow-2xl border border-zinc-800 animate-pop-in">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 text-white"><path d="M12 2L21 7V17L12 22L3 17V7L12 2Z" /><path d="M12 6L17 9V15L12 18L7 15V9L12 6" /></svg>
            </div>
            <h1 class="font-display text-5xl md:text-8xl font-black tracking-tighter text-white animate-reveal-up leading-none">NOTMINE<span class="text-zinc-600">4REAL</span></h1>
        </div>
    </div>

    <div id="menu-layer" class="fixed inset-0 z-40 bg-transparent hidden flex-col transition-all duration-1000 overflow-hidden pointer-events-auto"></div>

    <!-- TEAM / OWNERS LAYER -->
    <div id="team-layer" class="fixed inset-0 z-[150] bg-[#050505] hidden flex-col transition-all duration-700 opacity-0 scale-[1.05] pointer-events-none overflow-hidden">
        <div class="relative z-20 flex items-center justify-between px-8 h-20 glass-panel border-b border-white/5 shrink-0 pointer-events-auto">
            <button onclick="app.closeTeam()" class="flex items-center gap-3 px-4 py-2 bg-white text-black rounded-full font-bold font-display hover:bg-zinc-200 transition-colors"><i data-lucide="arrow-left" class="w-5 h-5"></i> Back</button>
            <h2 class="font-display font-black text-3xl tracking-tight text-white">System Team</h2>
            <div class="w-24"></div>
        </div>
        <div class="flex-1 overflow-y-auto p-6 md:p-10 relative z-10 pointer-events-auto flex flex-col items-center pt-20">
            <div class="mb-16 w-full max-w-2xl">
                <div class="text-center mb-8"><span class="text-accent font-mono text-sm tracking-[0.3em] font-bold uppercase mb-2 block">Creator & Lead Developer</span></div>
                <div class="bg-[#0a0a0a] border-2 owner-card-glow rounded-3xl p-10 flex flex-col items-center text-center transform transition-transform hover:scale-105 duration-500 relative overflow-hidden">
                    <div class="absolute inset-0 bg-accent/5 pointer-events-none"></div>
                    <div class="w-24 h-24 bg-accent rounded-full flex items-center justify-center mb-6 shadow-[0_0_30px_var(--accent)] relative z-10 text-white"><i data-lucide="crown" class="w-12 h-12"></i></div>
                    <h3 class="text-5xl font-display font-black text-white mb-2 relative z-10">Jessie Cook</h3>
                    <p class="text-accent font-sans text-3xl font-black tracking-[0.4em] mt-2 relative z-10 drop-shadow-lg">KING</p>
                </div>
            </div>
            <div class="w-full max-w-4xl border-t border-white/5 pt-16 text-center">
                <span class="text-zinc-500 font-mono text-sm tracking-[0.3em] font-bold uppercase mb-8 block">Administrators</span>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 opacity-50">
                    <div class="bg-[#0a0a0a] border border-white/5 rounded-2xl p-8 flex flex-col items-center border-dashed"><div class="w-16 h-16 bg-zinc-900 rounded-full flex items-center justify-center mb-4 text-zinc-600"><i data-lucide="user" class="w-8 h-8"></i></div><h4 class="text-xl font-bold text-zinc-500 mb-1">Vacant</h4><p class="text-xs font-mono text-zinc-600">No admin assigned</p></div>
                    <div class="bg-[#0a0a0a] border border-white/5 rounded-2xl p-8 flex flex-col items-center border-dashed"><div class="w-16 h-16 bg-zinc-900 rounded-full flex items-center justify-center mb-4 text-zinc-600"><i data-lucide="user" class="w-8 h-8"></i></div><h4 class="text-xl font-bold text-zinc-500 mb-1">Vacant</h4><p class="text-xs font-mono text-zinc-600">No admin assigned</p></div>
                    <div class="bg-[#0a0a0a] border border-white/5 rounded-2xl p-8 flex flex-col items-center border-dashed hidden md:flex"><div class="w-16 h-16 bg-zinc-900 rounded-full flex items-center justify-center mb-4 text-zinc-600"><i data-lucide="user" class="w-8 h-8"></i></div><h4 class="text-xl font-bold text-zinc-500 mb-1">Vacant</h4><p class="text-xs font-mono text-zinc-600">No admin assigned</p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- PARTNERS LAYER -->
    <div id="partners-layer" class="fixed inset-0 z-[150] bg-[#050505] hidden flex-col transition-all duration-700 opacity-0 scale-[1.05] pointer-events-none overflow-hidden">
        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-orange-900/20 via-black to-black pointer-events-none"></div>
        <div class="relative z-20 flex items-center justify-between px-8 h-20 glass-panel border-b border-orange-500/20 shrink-0 pointer-events-auto">
            <button onclick="app.closePartners()" class="flex items-center gap-3 px-4 py-2 bg-orange-500 text-black rounded-full font-bold font-display hover:bg-orange-400 transition-colors"><i data-lucide="arrow-left" class="w-5 h-5"></i> Back</button>
            <h2 class="font-display font-black text-3xl tracking-tight text-orange-500">Official Partners</h2>
            <div class="w-24"></div>
        </div>
        <div class="flex-1 overflow-y-auto p-6 md:p-10 relative z-10 pointer-events-auto flex items-center justify-center">
            <div class="grid grid-cols-1 max-w-4xl w-full">
                <a href="https://engineeringdesign.publicvm.com/" target="_blank" class="group relative bg-black border border-orange-500/30 rounded-3xl p-8 hover:border-orange-500 hover:shadow-[0_0_50px_rgba(249,115,22,0.2)] transition-all duration-500 flex flex-col md:flex-row items-center gap-8 overflow-hidden cursor-pointer">
                    <div class="absolute inset-0 bg-gradient-to-r from-orange-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <div class="w-48 h-48 shrink-0 bg-zinc-900/50 rounded-2xl p-4 flex items-center justify-center border border-orange-500/20 group-hover:scale-105 transition-transform duration-500">
                        <img src="https://raw.githubusercontent.com/NoahsAmazingTutoringHelp/reimagined-octo-winner/refs/heads/main/my%20logos/small_trans.png" alt="Noah's Tutoring Hub" class="w-full h-full object-contain drop-shadow-[0_0_15px_rgba(249,115,22,0.3)]" />
                    </div>
                    <div class="flex-1 text-center md:text-left relative z-10">
                        <div class="inline-block px-3 py-1 bg-orange-500/10 border border-orange-500/30 text-orange-500 text-[10px] font-mono font-bold uppercase tracking-widest rounded-full mb-4">Verified Network Partner</div>
                        <h3 class="text-4xl font-display font-black text-white mb-2 group-hover:text-orange-400 transition-colors">Noah's Tutoring Hub</h3>
                        <p class="text-zinc-400 font-sans text-lg mb-6 leading-relaxed">Top-tier academic assistance and unblocked resources. Joining forces to provide the ultimate student experience across the web.</p>
                        <span class="text-orange-500 font-bold flex items-center justify-center md:justify-start gap-2 group-hover:translate-x-2 transition-transform">Visit Hub <i data-lucide="arrow-right" class="w-5 h-5"></i></span>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- GAMES HUB LAYER -->
    <div id="library-layer" class="min-h-screen bg-transparent transition-all duration-700 ease-[cubic-bezier(0.16,1,0.3,1)] opacity-0 pointer-events-none h-0 overflow-hidden blur-xl transform origin-top">
        <nav class="sticky top-0 z-40 w-full pt-6 px-6 pb-4 transition-transform duration-500 bg-transparent" id="library-nav">
            <div class="max-w-7xl mx-auto flex items-center justify-between gap-6 pointer-events-auto">
                <div class="flex items-center gap-4 cursor-pointer group shrink-0" onclick="location.reload()">
                    <div class="w-12 h-12 bg-zinc-900 border border-zinc-800 rounded-dynamic flex items-center justify-center transform group-hover:rotate-[15deg] group-hover:scale-110 transition-all duration-300 relative overflow-hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="w-6 h-6 text-white relative z-10"><path d="M12 2L21 7V17L12 22L3 17V7L12 2Z"/><path d="M12 6L17 9V15L12 18L7 15V9L12 6"/></svg>
                    </div>
                    <div class="flex flex-col leading-none"><h1 class="font-display font-extrabold text-2xl tracking-tight text-white">NOTMINE</h1><span class="text-[10px] font-mono font-bold text-zinc-500 tracking-[0.3em] group-hover:text-white transition-colors mt-1">4REAL</span></div>
                </div>
                <div class="flex items-center gap-1.5 shrink-0 bg-zinc-900/60 backdrop-blur-xl border border-zinc-800/80 p-1.5 rounded-full shadow-xl">
                    <button onclick="app.playRandom()" class="p-2.5 text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-full transition-all"><i data-lucide="shuffle" class="w-5 h-5"></i></button>
                    <button onclick="app.openChat()" class="p-2.5 text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-full transition-all relative group"><i data-lucide="message-square" class="w-5 h-5"></i><span id="nav-chat-badge" class="absolute top-2 right-2 w-2.5 h-2.5 bg-accent rounded-full hidden border border-[#0a0a0a]"></span></button>
                    <button onclick="app.cloak()" class="p-2.5 text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-full transition-all"><i data-lucide="eye-off" class="w-5 h-5"></i></button>
                    <button onclick="app.openSettings()" class="p-2.5 text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-full transition-all"><i data-lucide="settings" class="w-5 h-5"></i></button>
                </div>
            </div>
        </nav>
        <main class="max-w-7xl mx-auto px-6 py-6 min-h-screen pointer-events-auto relative z-10">
            <div id="hero-section" class="flex flex-col items-center justify-center py-20 text-center animate-reveal-up">
                <h1 class="font-display font-black text-6xl md:text-7xl text-white tracking-tighter mb-4 drop-shadow-2xl">Games Library</h1>
                <p class="text-zinc-400 font-sans text-lg mb-10 max-w-xl mx-auto">Explore our extensive collection. Click any game to start playing immediately.</p>
                <div class="relative w-full max-w-2xl group animate-float">
                    <div class="absolute inset-0 bg-accent/20 rounded-full blur-xl group-hover:bg-accent/30 transition-all duration-500 opacity-50"></div>
                    <div class="relative flex items-center bg-zinc-900/80 backdrop-blur-md border border-white/10 rounded-full p-2 shadow-2xl transition-all duration-300 focus-within:border-accent/50 focus-within:bg-black">
                        <div class="pl-4 pr-3 text-zinc-500 group-focus-within:text-white transition-colors"><i data-lucide="search" class="w-6 h-6"></i></div>
                        <input type="text" id="search-input" placeholder="Search for a game..." class="w-full bg-transparent border-none py-3 text-lg text-white placeholder-zinc-600 focus:outline-none font-sans" autocomplete="off">
                    </div>
                </div>
                <p id="game-counter" class="text-zinc-600 font-mono text-xs mt-8 uppercase tracking-[0.2em] font-bold">Loading Database...</p>
            </div>
            <div class="flex flex-wrap items-center justify-center gap-2 mb-12 scrollbar-hide overflow-x-auto pb-2" id="filter-container"></div>
            <div id="games-grid" class="grid gap-x-6 gap-y-12 pb-32 transition-all duration-300" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--grid-gap);"></div>
        </main>
    </div>

    <!-- ADMIN MODALS -->
    <div id="admin-login-modal" class="fixed inset-0 z-[300] bg-black/90 backdrop-blur-xl hidden flex-col items-center justify-center pointer-events-auto">
        <div class="text-center w-full max-w-sm">
            <div class="w-20 h-20 bg-red-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-[0_0_40px_rgba(220,38,38,0.6)]"><i data-lucide="shield-alert" class="w-10 h-10 text-white"></i></div>
            <h2 class="text-3xl font-display font-black text-white mb-2 uppercase tracking-widest">Admin Access</h2>
            <p class="text-zinc-500 font-mono text-xs mb-8">SECURE SYSTEM // AUTHORIZED PERSONNEL ONLY</p>
            <input type="password" id="admin-password-input" placeholder="ENTER PASSCODE" class="w-full bg-black border-2 border-zinc-800 rounded-xl px-4 py-4 text-center text-xl text-white tracking-[0.5em] focus:outline-none focus:border-red-600 focus:shadow-[0_0_20px_rgba(220,38,38,0.4)] transition-all mb-4 font-mono">
            <button onclick="adminSystem.verify()" class="w-full py-4 bg-white text-black font-bold uppercase tracking-wider rounded-xl hover:bg-zinc-300 transition-colors">Authenticate</button>
            <button onclick="adminSystem.closeLogin()" class="mt-6 text-zinc-600 hover:text-white text-xs underline">Cancel</button>
        </div>
    </div>

    <div id="admin-layer" class="fixed inset-0 z-[250] bg-black hidden flex-col transition-all duration-300 overflow-hidden pointer-events-auto">
        <div class="h-20 border-b border-red-900/30 flex items-center justify-between px-8 bg-black shrink-0">
            <div class="flex items-center gap-4"><div class="w-3 h-3 bg-red-600 rounded-full animate-pulse"></div><h2 class="font-mono font-bold text-red-600 text-xl tracking-widest uppercase">Command Center</h2></div>
            <button onclick="adminSystem.closePanel()" class="px-4 py-2 border border-zinc-800 text-zinc-400 hover:text-white hover:border-white rounded text-xs font-mono uppercase">Exit Console</button>
        </div>
        <div class="flex-1 p-10 overflow-y-auto">
            <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <button onclick="adminSystem.sendCommand('global_alert', 'SYSTEM ALERT: Admin is speaking.')" class="p-8 border border-zinc-800 bg-zinc-900/30 hover:bg-zinc-800 hover:border-zinc-600 rounded-xl text-left transition-all group"><i data-lucide="megaphone" class="w-8 h-8 text-yellow-500 mb-4"></i><h3 class="text-xl font-bold text-white mb-2">Global Alert</h3><p class="text-zinc-500 text-xs font-mono">Send popup message to all users.</p></button>
                <button onclick="adminSystem.sendCommand('force_reload')" class="p-8 border border-zinc-800 bg-zinc-900/30 hover:bg-zinc-800 hover:border-zinc-600 rounded-xl text-left transition-all group"><i data-lucide="refresh-cw" class="w-8 h-8 text-blue-500 mb-4"></i><h3 class="text-xl font-bold text-white mb-2">Force Refresh</h3><p class="text-zinc-500 text-xs font-mono">Reload everyone's browser.</p></button>
                <button onclick="adminSystem.sendCommand('system_lock')" class="p-8 border border-zinc-800 bg-zinc-900/30 hover:bg-zinc-800 hover:border-zinc-600 rounded-xl text-left transition-all group"><i data-lucide="lock" class="w-8 h-8 text-red-500 mb-4"></i><h3 class="text-xl font-bold text-white mb-2">System Lock</h3><p class="text-zinc-500 text-xs font-mono">Trigger lock overlay globally.</p></button>
                <button onclick="adminSystem.sendCommand('rickroll')" class="p-8 border border-zinc-800 bg-zinc-900/30 hover:bg-zinc-800 hover:border-zinc-600 rounded-xl text-left transition-all group"><i data-lucide="music" class="w-8 h-8 text-purple-500 mb-4"></i><h3 class="text-xl font-bold text-white mb-2">Protocol 42</h3><p class="text-zinc-500 text-xs font-mono">Redirect everyone to Rickroll.</p></button>
                <button onclick="adminSystem.sendCommand('matrix_mode')" class="p-8 border border-zinc-800 bg-zinc-900/30 hover:bg-zinc-800 hover:border-zinc-600 rounded-xl text-left transition-all group"><i data-lucide="terminal" class="w-8 h-8 text-green-500 mb-4"></i><h3 class="text-xl font-bold text-white mb-2">Matrix Mode</h3><p class="text-zinc-500 text-xs font-mono">Inject CSS hacker theme.</p></button>
                <button onclick="adminSystem.sendCommand('clear_chat')" class="p-8 border border-zinc-800 bg-zinc-900/30 hover:bg-zinc-800 hover:border-zinc-600 rounded-xl text-left transition-all group"><i data-lucide="trash-2" class="w-8 h-8 text-zinc-400 mb-4"></i><h3 class="text-xl font-bold text-white mb-2">Wipe Chat</h3><p class="text-zinc-500 text-xs font-mono">Delete global chat history.</p></button>
            </div>
        </div>
    </div>

    <!-- CHAT UI -->
    <div id="chat-layer" class="fixed inset-0 z-[150] bg-[#050505] hidden flex-col transition-all duration-700 opacity-0 scale-[1.05] pointer-events-none overflow-hidden">
        <div class="relative z-20 flex items-center justify-between px-6 h-16 glass-panel border-b border-white/5 shrink-0 pointer-events-auto">
            <button onclick="app.closeChat()" class="flex items-center gap-2 px-4 py-2 bg-zinc-900 hover:bg-white hover:text-black text-zinc-300 rounded-full font-bold transition-colors"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
            <h2 class="font-display font-black text-xl text-white tracking-wide">Chat Room</h2>
            <div class="w-20"></div>
        </div>
        
        <!-- Add Friend/Group Modal -->
        <div id="add-modal" class="absolute inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden items-center justify-center opacity-0 transition-opacity duration-300 pointer-events-auto">
            <div class="bg-zinc-900 border border-zinc-700 p-6 rounded-2xl w-full max-w-md shadow-2xl relative">
                <button onclick="globalChat.closeAddModal()" class="absolute top-4 right-4 text-zinc-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                <h3 id="add-modal-title" class="text-xl font-bold text-white mb-4">Add Friend</h3>
                <div class="relative">
                    <input type="text" id="add-modal-input" oninput="globalChat.handleAutocomplete(event)" placeholder="Search Username..." class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white mb-4 focus:outline-none focus:border-accent relative z-10">
                    <div id="autocomplete-dropdown" class="absolute top-full left-0 w-full bg-zinc-800 border border-zinc-700 rounded-xl mt-1 hidden shadow-2xl max-h-40 overflow-y-auto z-50"></div>
                </div>
                <p id="add-modal-error" class="text-accent text-sm hidden mb-4"></p>
                <button onclick="globalChat.confirmAdd()" class="w-full py-3 bg-white text-black font-bold rounded-xl hover:bg-zinc-200 transition-colors">Confirm</button>
            </div>
        </div>

        <div id="friend-request-modal" class="absolute inset-0 z-[65] bg-black/80 backdrop-blur-sm hidden items-center justify-center opacity-0 transition-opacity duration-300 pointer-events-auto">
            <div class="bg-zinc-900 border border-zinc-700 p-8 rounded-2xl w-full max-w-sm shadow-2xl text-center">
                <div class="w-16 h-16 bg-accent rounded-full flex items-center justify-center mx-auto mb-4 text-white"><i data-lucide="user-plus" class="w-8 h-8"></i></div>
                <h3 class="text-2xl font-black text-white mb-2">Friend Request</h3>
                <p id="friend-request-name" class="text-zinc-400 mb-6">User wants to be friends!</p>
                <div class="flex gap-4">
                    <button onclick="globalChat.declineFriendRequest()" class="flex-1 py-3 bg-zinc-800 hover:bg-red-500 hover:text-white text-zinc-300 font-bold rounded-xl transition-colors">Decline</button>
                    <button onclick="globalChat.acceptFriendRequest()" class="flex-1 py-3 bg-white text-black font-bold rounded-xl hover:bg-zinc-200 transition-colors">Accept</button>
                </div>
            </div>
        </div>
        <div id="incoming-call-modal" class="absolute inset-0 z-[70] bg-black/90 backdrop-blur-md hidden items-center justify-center opacity-0 transition-opacity duration-300 pointer-events-auto">
            <div class="text-center">
                <div class="w-24 h-24 bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse-fast border-4 border-accent" id="incoming-call-icon-box"><i data-lucide="phone" class="w-10 h-10 text-white animate-bounce" id="incoming-call-icon"></i></div>
                <h3 class="text-3xl font-display font-black text-white mb-2" id="incoming-call-type-title">Incoming Call</h3>
                <p id="incoming-caller-name" class="text-zinc-400 text-lg mb-8">User is calling you...</p>
                <div class="flex items-center justify-center gap-6">
                    <button onclick="globalChat.declineCall()" class="w-16 h-16 bg-red-500 text-white rounded-full flex items-center justify-center hover:scale-110 transition-transform shadow-[0_0_20px_rgba(239,68,68,0.5)]"><i data-lucide="phone-off" class="w-6 h-6"></i></button>
                    <button onclick="globalChat.acceptCall()" class="w-16 h-16 bg-green-500 text-white rounded-full flex items-center justify-center hover:scale-110 transition-transform shadow-[0_0_20px_rgba(34,197,94,0.5)]"><i data-lucide="phone" class="w-6 h-6" id="incoming-accept-icon"></i></button>
                </div>
            </div>
        </div>
        <div id="active-call-bar" class="absolute top-16 left-0 right-0 z-30 bg-green-600/90 backdrop-blur-sm hidden items-center justify-between px-6 py-2 border-b border-green-500 shadow-lg pointer-events-auto">
            <div class="flex items-center gap-3"><i data-lucide="phone-call" class="w-5 h-5 text-white animate-pulse"></i><span class="text-white font-bold text-sm">Voice Call Active <span id="active-call-name" class="opacity-80 ml-1"></span></span></div>
            <button onclick="globalChat.endCall()" class="px-4 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded-full transition-colors">Hang Up</button>
        </div>
        <audio id="remote-audio" autoplay hidden></audio>
        <audio id="ringtone-audio" loop preload="auto" hidden src="https://cdn.pixabay.com/audio/2022/01/18/audio_d0a13f69d2.mp3"></audio>

        <div class="flex-1 flex overflow-hidden relative z-10 bg-black pointer-events-auto">
            <div class="w-64 border-r border-white/5 bg-[#080808] flex flex-col shrink-0">
                <div class="p-4 border-b border-white/5"><div class="flex items-center gap-3 bg-zinc-900 px-3 py-2 rounded-xl"><div class="w-8 h-8 rounded-full bg-accent text-white flex items-center justify-center font-bold text-sm" id="sidebar-user-initial">?</div><span class="font-bold text-white text-sm truncate" id="sidebar-username">Not Logged In</span></div></div>
                <div class="flex-1 overflow-y-auto p-3 space-y-6 scrollbar-hide">
                    <div><button onclick="globalChat.switchChannel('global', 'Global Chat')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors group channel-btn active-channel" data-id="global"><i data-lucide="globe" class="w-5 h-5 text-zinc-400 group-hover:text-white"></i><span class="font-bold text-zinc-300 group-hover:text-white">Global Room</span></button></div>
                    <div><div class="flex items-center justify-between px-2 mb-2"><span class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Friends</span><button onclick="globalChat.openAddModal('friend')" class="text-zinc-500 hover:text-white transition-colors"><i data-lucide="plus" class="w-4 h-4"></i></button></div><div id="friends-list" class="space-y-1"></div></div>
                    <div><div class="flex items-center justify-between px-2 mb-2"><span class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Groups</span><button onclick="globalChat.openAddModal('group')" class="text-zinc-500 hover:text-white transition-colors"><i data-lucide="plus" class="w-4 h-4"></i></button></div><div id="groups-list" class="space-y-1"></div></div>
                </div>
            </div>
            <div class="flex-1 flex flex-col bg-[#0a0a0a] relative">
                <div class="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-[#080808] shrink-0">
                    <div class="flex items-center gap-2"><i data-lucide="hash" class="w-4 h-4 text-zinc-500"></i><span class="font-bold text-white" id="current-room-name">Global Chat</span></div>
                    <div id="call-controls-container" class="hidden flex items-center gap-2">
                        <button onclick="globalChat.initiateCall(false)" class="p-2 bg-zinc-800 hover:bg-accent hover:text-white text-zinc-300 rounded-lg transition-colors" title="Voice Call"><i data-lucide="phone" class="w-4 h-4"></i></button>
                        <button onclick="globalChat.initiateCall(true)" class="p-2 bg-zinc-800 hover:bg-accent hover:text-white text-zinc-300 rounded-lg transition-colors" title="Video Call"><i data-lucide="video" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div id="video-call-ui" class="absolute inset-0 z-[40] bg-black hidden flex-col border-l border-white/5 pointer-events-auto">
                    <video id="remote-video" class="w-full h-full object-cover" autoplay playsinline></video>
                    <video id="local-video" class="absolute bottom-6 right-6 w-48 h-auto bg-zinc-900 border-2 border-white/10 rounded-xl shadow-2xl object-cover transform scale-x-[-1]" autoplay muted playsinline></video>
                    <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 flex items-center gap-6 bg-black/60 backdrop-blur-md px-6 py-3 rounded-full border border-white/10 shadow-2xl"><button onclick="globalChat.endCall()" class="w-14 h-14 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center text-white transition-colors shadow-lg"><i data-lucide="phone-off" class="w-6 h-6"></i></button></div>
                </div>
                
                <div id="chat-messages" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 scrollbar-hide relative z-10"></div>
                
                <div class="p-4 bg-[#080808] border-t border-white/5 relative z-10 flex flex-col">
                    <div id="reply-preview" class="hidden flex items-center justify-between bg-zinc-900 border-l-4 border-accent px-4 py-2 mb-3 rounded-r-lg shadow-inner">
                        <div class="truncate text-sm text-zinc-400 max-w-[80%]">Replying to <span id="reply-preview-user" class="font-bold text-white"></span>: <span id="reply-preview-text" class="italic"></span></div>
                        <button onclick="globalChat.cancelReply()" class="text-zinc-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                    <form id="chat-form" class="flex items-center gap-3">
                        <button type="button" id="chat-img-btn" onclick="document.getElementById('chat-img-upload').click()" class="p-3 bg-zinc-900 text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-xl transition-colors hidden" title="Send Image">
                            <i data-lucide="image" class="w-5 h-5"></i>
                        </button>
                        <input type="file" id="chat-img-upload" accept="image/*" class="hidden" onchange="globalChat.handleImageUpload(event)">
                        
                        <input type="text" id="chat-input" class="flex-1 bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-zinc-500 transition-colors disabled:opacity-50" placeholder="Type a message..." autocomplete="off" disabled>
                        <button type="submit" id="chat-submit-btn" class="p-3 bg-white text-black rounded-xl hover:bg-zinc-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled><i data-lucide="send" class="w-5 h-5"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS LAYER -->
    <div id="settings-layer" class="fixed inset-0 z-[150] bg-[#050505] hidden flex-col transition-all duration-700 opacity-0 scale-[1.05] pointer-events-none overflow-hidden">
        <div class="relative z-20 flex items-center justify-between px-8 h-20 glass-panel border-b border-white/5 shrink-0 pointer-events-auto">
            <div class="flex items-center gap-6">
                <button onclick="app.closeSettings()" class="flex items-center gap-3 px-4 py-2 bg-white text-black rounded-full font-bold font-display hover:bg-zinc-200 transition-colors"><i data-lucide="arrow-left" class="w-5 h-5"></i> Back</button>
                <div class="h-8 w-[1px] bg-zinc-800"></div><h2 class="font-display font-black text-3xl tracking-tight text-white">Settings</h2>
            </div>
        </div>
        <div class="flex flex-1 overflow-hidden relative z-10 pointer-events-auto">
            <div class="w-72 bg-[#080808] border-r border-white/5 flex flex-col p-6 space-y-2 overflow-y-auto scrollbar-hide shrink-0" id="settings-nav"></div>
            <div class="flex-1 bg-black overflow-y-auto scrollbar-hide relative p-10">
                <div class="max-w-4xl mx-auto"><div class="mb-10"><h3 id="settings-cat-title" class="text-5xl font-display font-black text-white tracking-tighter mb-2">Category</h3></div><div id="settings-options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20"></div></div>
            </div>
        </div>
    </div>

    <!-- VIEWER LAYER -->
    <div id="viewer-layer" class="fixed inset-0 z-[100] bg-[#050505] hidden flex-col transition-all duration-700 opacity-0 scale-[1.02] pointer-events-none">
        <div id="viewer-bg" class="absolute inset-0 opacity-15 pointer-events-none blur-[100px] scale-110 bg-cover bg-center transition-opacity"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/95 to-black/80 pointer-events-none"></div>
        <div class="relative z-10 flex items-center justify-between px-6 h-16 glass-panel border-b border-white/5 pointer-events-auto">
            <div class="flex items-center gap-4">
                <button onclick="app.closeViewer()" class="p-2 hover:bg-zinc-800/50 rounded-lg transition-colors group"><i data-lucide="arrow-left" class="w-5 h-5 text-zinc-400 group-hover:text-white"></i></button>
                <div class="h-6 w-[1px] bg-zinc-800"></div>
                <div><h2 id="viewer-title" class="font-display font-bold text-white text-lg leading-none tracking-tight">Title</h2><p id="viewer-category" class="text-[11px] text-zinc-500 font-mono tracking-widest uppercase mt-1">Category</p></div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="app.panic()" class="flex items-center gap-2 px-4 py-1.5 bg-zinc-900 hover:bg-white hover:text-black text-zinc-400 text-xs font-bold tracking-widest uppercase rounded-lg transition-colors border border-zinc-800"><i data-lucide="alert-triangle" class="w-3 h-3"></i> PANIC</button>
                <button onclick="app.toggleFullscreen()" class="p-2.5 text-zinc-400 hover:text-white hover:bg-zinc-800/50 rounded-lg transition-all"><i data-lucide="maximize" class="w-5 h-5"></i></button>
            </div>
        </div>
        <div class="flex-1 relative flex items-center justify-center p-4 md:p-8 overflow-hidden pointer-events-auto">
            <div id="game-container" class="relative w-full h-full max-w-[1600px] max-h-[900px] bg-[#0a0a0a] rounded-dynamic overflow-hidden shadow-[0_0_60px_rgba(0,0,0,0.8)] border border-zinc-800/80">
                <iframe id="game-frame" class="w-full h-full border-0 rounded-dynamic" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL DATABASE INIT ---
        let db = null;
        try {
            const firebaseConfig = {
              apiKey: "AIzaSyDKqhSa-fFT-R8DGWeGq0tFsuHySTto2NU",
              authDomain: "notminechat-71bd0.firebaseapp.com",
              databaseURL: "https://notminechat-71bd0-default-rtdb.firebaseio.com",
              projectId: "notminechat-71bd0",
              storageBucket: "notminechat-71bd0.firebasestorage.app",
              messagingSenderId: "446821268917",
              appId: "1:446821268917:web:181c7ad0e0b4241b02adfc"
            };
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch(e) { console.error("Firebase Error: ", e); }

        var _GAMES = [
            ["Web Proxy", "https://d1ks901xvjj2p6.cloudfront.net/index.html#/search", "https://th.bing.com/th?q=Proxy+Adobe+PNG+Logo&w=120&h=120&c=1&rs=1&qlt=70&o=7&cb=1&dpr=1.1&pid=InlineBlock&rm=3&defcache=1&mkt=en-US&cc=US&setlang=en&adlt=moderate&t=1&mw=247", "Utility"],
            ["School boy runaway", "https://cookjessie383-wixsite-com.filesusr.com/html/308cff_32c0c8b002c4cb975a08f1c4e11993e2.html", "https://cdn.jsdelivr.net/gh/gn-math/covers@main/605.png", "Action"],
            ["Five Nights at Freddy's: Pizza Simulator", "https://cookjessie383-wixsite-com.filesusr.com/html/308cff_8fd1120b36baff86409a8a249b866bfa.html", "https://cdn.jsdelivr.net/gh/gn-math/covers@main/191.png", "Horror"],
            ["Kindergarten 1", "https://cookjessie383-wixsite-com.filesusr.com/html/308cff_ef521b915ffa7ef66db86684a0954a82.html", "https://cdn.jsdelivr.net/gh/gn-math/covers@main/445.png", "Simulation"],
            ["Fears to fathom","https://cookjessie383-wixsite-com.filesusr.com/html/308cff_572aa2e68dc88d7bf012e5521b5f5970.html","https://th.bing.com/th/id/OIP.pZgZfCleZe6OEQmMKUwwrAHaEK?w=300&h=180&c=7&r=0&o=7&cb=ucfimg2&pid=1.7&rm=3&ucfimg=1","Horror"],
            ["FNAF 1","https://cookjessie383-wixsite-com.filesusr.com/html/308cff_88f80b2f48655ffe2d93c945dd97c8dc.html","https://th.bing.com/th/id/OIP.tzsQpIaytSceo6d7z-pNBAHaEK?w=326&h=183&c=7&r=0&o=5&pid=1.7","Horror"],
            ["Baldi's Basics","https://cookjessie383-wixsite-com.filesusr.com/html/308cff_b49415c7838d5272bed3689dc5bf5f3a.html","https://th.bing.com/th/id/OIP.v_jCMioFl5pXyG7IwRLZ9gHaEK?w=308&h=180&c=7&r=0&o=7&cb=ucfimg2&pid=1.7&rm=3&ucfimg=1","Horror"],
            ["Drift hunters","https://sgs-game-cdn.pages.dev/Projects/Drift%20Hunters/main","https://th.bing.com/th/id/OIP.R5-k2knM3MzQGSbXhLbLKAHaEJ?w=304&h=180&c=7&r=0&o=7&cb=ucfimg2&pid=1.7&rm=3&ucfimg=1","Racing"],
            ["Blade Ball","https://cookjessie383-wixsite-com.filesusr.com/html/308cff_bbde690928dfba35150bd1a7cf17c993.html","https://th.bing.com/th/id/OIP.w9Bq0azXbFtMkqLSje-z5QAAAA?w=234&h=180&c=7&r=0&o=7&cb=ucfimg2&pid=1.7&rm=3&ucfimg=1","Arcade"],
            ["Minecraft 1.12","https://cookjessie383-wixsite-com.filesusr.com/html/308cff_2dd5de6cb688fee72be5cbab95e095a0.html","https://th.bing.com/th/id/OIP.YfwEzGWk99WxLiQZXMTw1AHaEK?w=321&h=180&c=7&r=0&o=7&cb=ucfimg2&pid=1.7&rm=3&ucfimg=1","Sandbox"],
            ["Super Mario 64","https://sgs-game-cdn.pages.dev/Projects/Super%20Mario%2064/main","https://th.bing.com/th/id/OIP.NJpccXzTJ0OHPflJYWgYJAHaEK?w=274&h=180&c=7&r=0&o=7&cb=ucfimg2&pid=1.7&rm=3&ucfimg=1","Retro"],
            ["Super hot","https://sgs-game-cdn.pages.dev/Projects/SuperHot/main","https://th.bing.com/th/id/OIP.5V1RdBCu6Mh0q9a1M_sfKAHaEK?w=321&h=180&c=7&r=0&o=7&cb=ucfimg2&pid=1.7&rm=3&ucfimg=1","Action"],
            ["Only up","https://cookjessie383-wixsite-com.filesusr.com/html/308cff_4fa7e24a1a30d8d8390701c57ece7d60.html","https://th.bing.com/th/id/OIP.fZ1gZeFVMMWhSBosF5ezxAHaF0?w=239&h=187&c=7&r=0&o=7&cb=ucfimg2&pid=1.7&rm=3&ucfimg=1","Arcade"],
            ["Chrome dino","https://cookjessie383-wixsite-com.filesusr.com/html/308cff_908edc67fbe3f9f03b98e4ec322cbfa1.html","https://th.bing.com/th/id/OIP.AXkOaVfMJMHuPZ0kut5tPQHaEO?w=267&h=180&c=7&r=0&o=5&pid=1.7","Arcade"],
            ["Subway surfers","https://cookjessie383-wixsite-com.filesusr.com/html/308cff_2f468b2d851e314d09dcd63a635fb832.html","https://th.bing.com/th/id/OIP.h-kgCIZHfbEcXyvc1ksbWwHaEK?w=208&h=150&c=6&o=7&cb=ucfimg2&pid=1.7&rm=3&ucfimg=1","Arcade"],
            ["1v1.lol","https://cookjessie383-wixsite-com.filesusr.com/html/308cff_86ec7f8b730df71e730127f41f76e9dd.html","https://th.bing.com/th/id/OIP.ASM6tUWCDbxvnZvSQT1GWgHaD4?w=309&h=180&c=7&r=0&o=7&cb=ucfimg2&pid=1.7&rm=3&ucfimg=1","Action"]
        ];

        const GAMES = _GAMES.map(g => ({ title: g[0], url: g[1], image: g[2], category: g[3] }));
        const CATEGORIES = ['All', 'Action', 'Horror', 'Racing', 'Arcade', 'Simulation', 'Retro', 'Strategy', 'Favorites'];

        class AccountSystem {
            constructor() {
                this.username = localStorage.getItem('nm4r-user');
                this.password = localStorage.getItem('nm4r-pass');
            }

            async authenticate(e) {
                e.preventDefault();
                const user = document.getElementById('auth-user').value.trim();
                const pass = document.getElementById('auth-pass').value.trim();
                if(!user || !pass) return;

                const btn = document.getElementById('auth-btn');
                btn.textContent = "Authenticating...";

                try {
                    const snap = await db.ref(`accounts/${user}`).once('value');
                    const data = snap.val();

                    if (data) {
                        if (data.password === pass) {
                            this.completeLogin(user, pass, data);
                        } else {
                            alert("Incorrect Password!");
                            btn.textContent = "Login / Create";
                        }
                    } else {
                        // Create new account
                        const newData = {
                            password: pass,
                            favorites: JSON.parse(localStorage.getItem('nm4r-favorites') || '[]'),
                            settings: JSON.parse(localStorage.getItem('nm4r-settings') || '{}')
                        };
                        await db.ref(`accounts/${user}`).set(newData);
                        this.completeLogin(user, pass, newData);
                    }
                } catch(err) {
                    console.log(err);
                    alert("Network error.");
                    btn.textContent = "Login / Create";
                }
            }

            completeLogin(user, pass, data) {
                localStorage.setItem('nm4r-user', user);
                localStorage.setItem('nm4r-pass', pass);
                // Also set custom user for chat system legacy compatibility
                localStorage.setItem('nm4r-custom-user', user); 

                if(data.favorites) localStorage.setItem('nm4r-favorites', JSON.stringify(data.favorites));
                if(data.settings) localStorage.setItem('nm4r-settings', JSON.stringify(data.settings));

                this.username = user;
                app.favorites = new Set(data.favorites || []);
                app.settings = { ...app.settings, ...(data.settings || {}) };
                app.applySettings();
                app.renderLibrary();

                // HIDE AUTH MODAL
                document.getElementById('auth-modal').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => document.getElementById('auth-modal').classList.add('hidden'), 500);

                // RE-INITIALIZE CHAT with user
                if(globalChat) {
                    globalChat.username = user;
                    // FORCE SIDEBAR UPDATE
                    document.getElementById('sidebar-username').textContent = user;
                    document.getElementById('sidebar-user-initial').textContent = user.charAt(0).toUpperCase();
                    // FORCE INPUT UNLOCK
                    globalChat.input.disabled = false;
                    globalChat.submitBtn.disabled = false;

                    globalChat.db.ref(`users/${user}`).set(Date.now());
                    globalChat.renderSidebar();
                    globalChat.listenForCalls();
                    globalChat.listenForFriendRequests();
                } else {
                    globalChat = new ChatSystem();
                }
                
                // Immediately update UI to logged in state
                app.openChat();
            }

            async changeName() {
                const newName = prompt("Enter new username:");
                if(!newName || newName === this.username) return;

                const snap = await db.ref(`accounts/${newName}`).once('value');
                if(snap.val()) {
                    alert("Username already taken!");
                    return;
                }

                const dataSnap = await db.ref(`accounts/${this.username}`).once('value');
                const oldData = dataSnap.val();

                await db.ref(`accounts/${newName}`).set(oldData);
                await db.ref(`accounts/${this.username}`).remove();

                localStorage.setItem('nm4r-user', newName);
                alert("Username changed! Reloading system...");
                location.reload();
            }

            async syncData() {
                if(!this.username) return;
                const data = {
                    password: this.password,
                    favorites: JSON.parse(localStorage.getItem('nm4r-favorites') || '[]'),
                    settings: JSON.parse(localStorage.getItem('nm4r-settings') || '{}')
                };
                await db.ref(`accounts/${this.username}`).set(data);
                alert("Cloud Sync Complete!");
            }
            
            async nuclearReset() {
                if(confirm("WARNING: This will delete ALL user accounts from the database. Are you sure?")) {
                    await db.ref('accounts').remove();
                    alert("All accounts wiped.");
                    location.reload();
                }
            }
            
            logout() {
                localStorage.removeItem('nm4r-user');
                localStorage.removeItem('nm4r-pass');
                location.reload();
            }
        }

        const accountSystem = new AccountSystem();

        class App {
            constructor() {
                this.activeCategory = 'All'; this.searchQuery = ''; this.currentGame = null;
                this.favorites = new Set(JSON.parse(localStorage.getItem('nm4r-favorites') || '[]'));
                this.activeSettingsTab = 'Design'; this.previousLayer = 'menu';
                this.isChatOpen = false;
                this.settings = { 
                    perfMode: false, oledMode: false, compactUI: false, glassmorphism: true, 
                    borderRadius: '1rem', gridGap: '1.5rem', ambientBg: true, hoverFx: true, 
                    cursorStyle: 'default', fontBase: 'Outfit', fontHead: 'Space Grotesk', textSize: '16px', 
                    tabTitle: 'NOTMINE4REAL', tabIcon: '', panicUrl: 'https://classroom.google.com', 
                    panicKey: '`', accentColor: '#8b5cf6'
                };
                this.init();
            }

            init() {
                try { const s = JSON.parse(localStorage.getItem('nm4r-settings')); if (s) this.settings = { ...this.settings, ...s }; } catch(e){}
                this.applySettings(); this.setupSecurity(); lucide.createIcons();
                document.getElementById('search-input')?.addEventListener('input', e => { this.searchQuery = e.target.value; this.renderLibrary(); });
                if (window.self !== window.top) this.showLauncher(); else this.runIntro();
                this.listenForAdminCommands();
            }

            showLauncher() { document.getElementById('launcher-layer').classList.remove('hidden', 'opacity-0'); }
            launchApp() { window.open(window.location.href, '_blank'); }

            runIntro() {
                document.getElementById('launcher-layer').classList.add('hidden');
                const cs = document.getElementById('cutscene-layer');
                cs.classList.remove('hidden');
                setTimeout(() => { document.getElementById('cs-logo').classList.remove('hidden'); lucide.createIcons(); }, 300);
                setTimeout(() => { 
                    cs.classList.add('animate-slide-up-out'); 
                    this.showMainMenu(); 
                }, 2000);
                setTimeout(() => { cs.classList.add('hidden'); }, 3000);
            }

            showMainMenu() { this.previousLayer = 'menu'; const menu = document.getElementById('menu-layer'); menu.classList.remove('hidden'); menu.classList.add('flex'); document.body.classList.add('overflow-hidden'); this.renderMainMenu(); this.setupMenuTilt(); lucide.createIcons(); }
            
            renderMainMenu() {
                const layer = document.getElementById('menu-layer');
                const heroGame = GAMES.find(g => g.title === "Minecraft 1.12") || GAMES[0];
                this.menuPreviewData = { games: { isGame: false }, featured: { isGame: true, title: heroGame.title, desc: "Play now.", img: heroGame.image, tag: "Featured" }, random: { isGame: true, title: "Random Game", desc: "Play something new.", img: GAMES[1].image, tag: "Random" }, partners: { isGame: false }, team: { isGame: false }, chat: { isGame: false }, settings: { isGame: false } };
                
                layer.innerHTML = `
                    <div id="menu-ambient-bg" class="absolute inset-0 bg-transparent"></div>
                    <div id="menu-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-700 opacity-0 blur-xl scale-110"></div>
                    <div class="relative z-10 w-full h-full flex flex-col md:flex-row items-center justify-center p-8 md:p-16 lg:p-24 gap-12 lg:gap-24">
                        <div class="w-full md:w-[45%] flex flex-col justify-center space-y-8 animate-reveal-up">
                            <div class="mb-6"><h1 class="font-display font-extrabold text-6xl md:text-[5.5rem] text-white tracking-tighter leading-[0.85] mb-4">NOTMINE<span class="text-zinc-600 block md:inline">4REAL</span></h1></div>
                            <div class="flex flex-col space-y-1">
                                ${this.createMenuItem('GAMES', 'enterLibrary()', 'games', 'layout-grid')}
                                ${this.createMenuItem('FEATURED', `openViewer('${heroGame.title.replace(/'/g, "\\'")}')`, 'featured', 'star')}
                                ${this.createMenuItem('PARTNERS', 'openPartners()', 'partners', 'handshake')}
                                ${this.createMenuItem('CHAT', 'openChat()', 'chat', 'message-square')}
                                ${this.createMenuItem('SETTINGS', 'openSettings()', 'settings', 'settings')}
                                ${this.createMenuItem('TEAM', 'openTeam()', 'team', 'users')}
                            </div>
                        </div>
                        <div class="hidden md:flex w-full md:w-[55%] h-full max-h-[600px] items-center justify-center">
                             <div id="menu-preview-card" class="w-full max-w-xl aspect-video bg-zinc-900 rounded-[2rem] overflow-hidden relative shadow-[0_0_50px_rgba(0,0,0,0.8)] border border-white/10 transition-all duration-700 opacity-0 scale-95 pointer-events-none group perspective-1000">
                                  <img id="menu-preview-img" src="" class="w-full h-full object-cover transition-transform duration-[1.5s] ease-out group-hover:scale-110 opacity-80" />
                                  <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent opacity-90"></div>
                                  <div class="absolute bottom-0 left-0 p-10 w-full transform transition-transform duration-500 translate-y-4 group-hover:translate-y-0">
                                      <div class="flex items-center justify-between mb-4"><div id="menu-preview-tag" class="px-4 py-1.5 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-white text-xs font-bold uppercase tracking-widest">Tag</div></div>
                                      <h2 id="menu-preview-title" class="font-display font-extrabold text-5xl text-white mb-2 leading-tight drop-shadow-lg">Title</h2>
                                      <p id="menu-preview-desc" class="font-sans text-zinc-300 text-lg opacity-80">Desc</p>
                                  </div>
                             </div>
                        </div>
                    </div>`;
            }

            createMenuItem(text, action, key, icon) { return `<button onclick="app.${action}" onmouseenter="app.updateMenuPreview('${key}')" class="group w-full text-left py-6 border-b border-zinc-900 hover:border-zinc-500 transition-colors duration-500 flex items-center justify-between relative overflow-hidden"><span class="font-display font-bold text-4xl md:text-5xl tracking-tight text-zinc-600 group-hover:text-white transition-colors duration-500 relative z-10">${text}</span><div class="flex items-center gap-6 relative z-10 transform translate-x-4 opacity-0 group-hover:translate-x-0 group-hover:opacity-100 transition-all duration-500 ease-out"><div class="w-10 h-10 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center group-hover:bg-white group-hover:text-black transition-all duration-500"><i data-lucide="${icon}" class="w-5 h-5"></i></div></div></button>`; }
            
            updateMenuPreview(key) { 
                const data = this.menuPreviewData[key]; const card = document.getElementById('menu-preview-card'); const bg = document.getElementById('menu-bg'); 
                if(key === 'partners' || key === 'team') { if(card) { card.classList.remove('opacity-100', 'scale-100'); card.classList.add('opacity-0', 'scale-95'); } if(bg) bg.style.opacity = '0'; return; } 
                if(!data || !data.isGame) { if(card) { card.classList.remove('opacity-100', 'scale-100'); card.classList.add('opacity-0', 'scale-95'); } if(bg) bg.style.opacity = '0'; return; } 
                if(card) { card.classList.remove('opacity-0', 'scale-95'); card.classList.add('opacity-100', 'scale-100'); } if(bg && data.img) { bg.style.backgroundImage = `url('${data.img}')`; bg.style.opacity = '0.4'; } 
                if(document.getElementById('menu-preview-img')) document.getElementById('menu-preview-img').src = data.img; if(document.getElementById('menu-preview-title')) document.getElementById('menu-preview-title').textContent = data.title; if(document.getElementById('menu-preview-desc')) document.getElementById('menu-preview-desc').textContent = data.desc; if(document.getElementById('menu-preview-tag')) document.getElementById('menu-preview-tag').textContent = data.tag; 
            }
            
            setupMenuTilt() { if (this.menuTiltListener) document.removeEventListener('mousemove', this.menuTiltListener); this.menuTiltListener = (e) => { const card = document.getElementById('menu-preview-card'); if(!card || card.classList.contains('opacity-0')) return; const x = (e.clientX / window.innerWidth - 0.5) * 20; const y = (e.clientY / window.innerHeight - 0.5) * 20; card.style.transform = `perspective(1000px) rotateY(${x}deg) rotateX(${-y}deg) scale3d(1.02, 1.02, 1.02)`; }; document.addEventListener('mousemove', this.menuTiltListener); }
            
            enterLibrary() { this.previousLayer = 'library'; const menu = document.getElementById('menu-layer'); menu.classList.add('opacity-0', 'scale-[1.05]', 'pointer-events-none'); setTimeout(() => { menu.classList.add('hidden'); const lib = document.getElementById('library-layer'); lib.classList.remove('opacity-0', 'pointer-events-none', 'h-0', 'blur-xl', 'overflow-hidden'); lib.classList.add('opacity-100', 'blur-none', 'pointer-events-auto'); document.body.classList.remove('overflow-hidden'); this.renderLibrary(); }, 800); }
            
            renderLibrary() {
                const filters = document.getElementById('filter-container');
                filters.innerHTML = CATEGORIES.map(cat => `<button onclick="app.setCategory('${cat}')" class="px-6 py-2 rounded-full text-sm font-bold tracking-wide transition-all ${this.activeCategory === cat ? 'bg-white text-black shadow-[0_0_15px_rgba(255,255,255,0.2)]' : 'bg-zinc-900/50 text-zinc-400 hover:bg-zinc-800 border border-zinc-800/50'}">${cat}</button>`).join('');
                const grid = document.getElementById('games-grid');
                let games = GAMES; if (this.activeCategory === 'Favorites') games = games.filter(g => this.favorites.has(g.title)); else if (this.activeCategory !== 'All') games = games.filter(g => g.category === this.activeCategory); if (this.searchQuery) games = games.filter(g => g.title.toLowerCase().includes(this.searchQuery.toLowerCase()));
                const counter = document.getElementById('game-counter'); if(counter) counter.textContent = `${games.length} Games Loaded`;
                grid.innerHTML = games.map(g => `<div class="group relative game-card-wrapper h-full flex flex-col cursor-pointer" onclick="app.openViewer('${g.title.replace(/'/g, "\\'")}')"><div class="flex-1 flex flex-col bg-[#0a0a0a] rounded-dynamic border border-white/5 p-3 hover-trigger transition-all duration-300 ${this.settings.hoverFx ? 'hover:border-zinc-600 hover:bg-zinc-900 hover:shadow-[0_15px_30px_rgba(0,0,0,0.8)] hover:-translate-y-2 relative z-0 hover:z-50' : ''}"><div class="w-full aspect-video overflow-hidden rounded-[calc(var(--radius)-0.25rem)] bg-black relative shrink-0"><img src="${g.image}" class="w-full h-full object-cover transition-transform duration-700 ${this.settings.hoverFx ? 'group-hover:scale-110' : ''}" onerror="this.style.display='none'" /></div><div class="mt-4 px-1 pb-1 flex-1 flex flex-col justify-between"><div class="flex items-start justify-between gap-2"><h3 class="font-display font-bold text-white text-lg leading-tight line-clamp-2">${g.title}</h3><button onclick="app.toggleFav('${g.title.replace(/'/g, "\\'")}', event)" class="p-1.5 rounded-md hover:bg-zinc-800 shrink-0"><i data-lucide="heart" class="w-4 h-4 ${this.favorites.has(g.title) ? 'fill-red-500 text-red-500' : 'text-zinc-500'}"></i></button></div><p class="text-[10px] font-mono text-zinc-600 uppercase mt-3">${g.category}</p></div></div></div>`).join('');
                lucide.createIcons();
            }

            setCategory(cat) { this.activeCategory = cat; this.renderLibrary(); }
            toggleFav(t, e) { e.stopPropagation(); this.favorites.has(t) ? this.favorites.delete(t) : this.favorites.add(t); localStorage.setItem('nm4r-favorites', JSON.stringify([...this.favorites])); this.renderLibrary(); }
            playRandomFromMenu() { this.enterLibrary(); setTimeout(() => this.playRandom(), 800); }
            playRandom() { const a = GAMES; if(a.length) this.openViewer(a[Math.floor(Math.random()*a.length)].title); }

            // TEAM PAGE
            openTeam() {
                document.body.classList.add('overflow-hidden');
                document.getElementById('menu-layer').classList.add('hidden');
                const t = document.getElementById('team-layer');
                t.classList.remove('hidden', 'opacity-0', 'scale-[1.05]', 'pointer-events-none');
                t.classList.add('flex', 'opacity-100', 'scale-100', 'pointer-events-auto');
            }
            closeTeam() {
                const t = document.getElementById('team-layer');
                t.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
                t.classList.add('opacity-0', 'scale-[1.05]', 'pointer-events-none');
                setTimeout(() => {
                    t.classList.add('hidden'); t.classList.remove('flex');
                    document.getElementById('menu-layer').classList.remove('hidden');
                    document.getElementById('menu-layer').classList.add('flex');
                }, 700);
            }

            // PARTNERS PAGE
            openPartners() {
                document.body.classList.add('overflow-hidden');
                document.getElementById('menu-layer').classList.add('hidden');
                const p = document.getElementById('partners-layer');
                p.classList.remove('hidden', 'opacity-0', 'scale-[1.05]', 'pointer-events-none');
                p.classList.add('flex', 'opacity-100', 'scale-100', 'pointer-events-auto');
            }
            closePartners() {
                const p = document.getElementById('partners-layer');
                p.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
                p.classList.add('opacity-0', 'scale-[1.05]', 'pointer-events-none');
                setTimeout(() => {
                    p.classList.add('hidden'); p.classList.remove('flex');
                    document.getElementById('menu-layer').classList.remove('hidden');
                    document.getElementById('menu-layer').classList.add('flex');
                }, 700);
            }

            openChat() { 
                if(!accountSystem.username) {
                    const modal = document.getElementById('auth-modal');
                    modal.classList.remove('hidden');
                    setTimeout(()=> modal.classList.remove('opacity-0'), 10);
                    return;
                }

                this.isChatOpen = true; 
                document.body.classList.add('overflow-hidden'); 
                document.getElementById('nav-chat-badge')?.classList.add('hidden'); 
                document.getElementById('chat-layer').classList.remove('hidden', 'opacity-0', 'scale-[1.05]', 'pointer-events-none'); 
                document.getElementById('chat-layer').classList.add('flex', 'opacity-100', 'scale-100', 'pointer-events-auto'); 
                if(this.previousLayer === 'menu') document.getElementById('menu-layer').classList.add('hidden'); 
                if(this.previousLayer === 'library') document.getElementById('library-layer').classList.add('hidden'); 
                if (globalChat) { 
                    // CRITICAL FIX: Ensure user is recognized as logged in instantly
                    globalChat.checkUsername(); 
                    globalChat.scrollToBottom(); 
                } 
            }
            closeChat() { this.isChatOpen = false; const layer = document.getElementById('chat-layer'); layer.classList.add('opacity-0', 'scale-[1.05]', 'pointer-events-none'); layer.classList.remove('opacity-100', 'scale-100'); setTimeout(() => { layer.classList.add('hidden'); layer.classList.remove('flex'); if(this.previousLayer === 'menu') { document.getElementById('menu-layer').classList.remove('hidden'); document.getElementById('menu-layer').classList.add('flex'); } if(this.previousLayer === 'library') { document.getElementById('library-layer').classList.remove('hidden'); document.body.classList.remove('overflow-hidden'); } }, 700); }

            openSettings() { document.body.classList.add('overflow-hidden'); document.getElementById('settings-layer').classList.remove('hidden', 'opacity-0', 'scale-[1.05]', 'pointer-events-none'); document.getElementById('settings-layer').classList.add('flex', 'opacity-100', 'scale-100', 'pointer-events-auto'); if(this.previousLayer === 'menu') document.getElementById('menu-layer').classList.add('hidden'); if(this.previousLayer === 'library') document.getElementById('library-layer').classList.add('hidden'); this.renderSettingsNav(); this.renderSettingsContent(); }
            closeSettings() { const layer = document.getElementById('settings-layer'); layer.classList.add('opacity-0', 'scale-[1.05]', 'pointer-events-none'); layer.classList.remove('opacity-100', 'scale-100'); setTimeout(() => { layer.classList.add('hidden'); layer.classList.remove('flex'); if(this.previousLayer === 'menu') { document.getElementById('menu-layer').classList.remove('hidden'); document.getElementById('menu-layer').classList.add('flex'); } if(this.previousLayer === 'library') { document.getElementById('library-layer').classList.remove('hidden'); document.body.classList.remove('overflow-hidden'); } }, 700); }

            renderSettingsNav() { const nav = document.getElementById('settings-nav'); const cats = ['Account', 'Design', 'Site', 'Security', 'Themes']; nav.innerHTML = cats.map(c => `<button onclick="app.activeSettingsTab='${c}'; app.renderSettingsContent();" class="text-left px-5 py-4 rounded-xl font-bold font-display transition-all ${this.activeSettingsTab === c ? 'bg-zinc-800 text-white shadow-md' : 'text-zinc-500 hover:text-white hover:bg-zinc-900'}">${c}</button>`).join('') + `<div class="mt-auto pt-6 border-t border-white/5"><button onclick="adminSystem.openLogin()" class="w-full px-5 py-3 text-red-900/50 hover:text-red-500 hover:bg-red-900/10 text-xs font-bold font-mono tracking-widest text-center rounded-xl transition-colors">ADMIN</button></div>`; }
            renderSettingsContent() { 
                this.renderSettingsNav(); 
                document.getElementById('settings-cat-title').textContent = this.activeSettingsTab; 
                const grid = document.getElementById('settings-options-grid'); 
                let optionsHtml = ''; 
                
                const createRow = (title, type, key, extras) => { const val = this.settings[key]; let control = ''; if(type === 'toggle') { control = `<button onclick="app.updateSetting('${key}', ${!val})" class="w-12 h-6 rounded-full relative transition-colors duration-300 ${val ? 'bg-accent shadow-[0_0_10px_var(--accent)]' : 'bg-black border border-zinc-700'} shrink-0 focus:outline-none"><div class="absolute top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 ${val ? 'translate-x-7' : 'translate-x-1'}"></div></button>`; } else if (type === 'action') { control = `<button onclick="app.updateSetting('${key}', '${extras.match}')" class="px-4 py-2 rounded-lg text-sm font-bold ${extras.match === val ? 'bg-white text-black' : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700'} transition-colors">${extras.label}</button>`; } else if (type === 'input') { control = `<input type="text" value="${val}" onchange="app.updateSetting('${key}', this.value)" placeholder="${extras.ph}" class="w-full mt-3 bg-black border border-zinc-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-zinc-500 font-mono">`; } return `<div class="bg-zinc-900/30 border border-zinc-800/50 rounded-2xl p-5 flex flex-col justify-center"><div class="flex items-center justify-between gap-4"><span class="text-base font-medium text-zinc-200">${title}</span>${type !== 'input' ? control : ''}</div>${type === 'input' ? control : ''}</div>`; };
                
                if(this.activeSettingsTab === 'Account') {
                    optionsHtml = `
                    <div class="bg-zinc-900/30 border border-zinc-800/50 rounded-2xl p-6 flex flex-col gap-4 col-span-full">
                        <div class="flex items-center justify-between">
                            <div><h4 class="text-xl font-bold text-white">Cloud Profile</h4><p class="text-sm text-zinc-400 mt-1">Logged in as: <span class="text-accent font-bold">${accountSystem.username || 'Guest'}</span></p></div>
                            <div class="flex gap-2">
                                <button onclick="accountSystem.changeName()" class="px-4 py-2 bg-zinc-800 hover:bg-white hover:text-black text-white text-sm font-bold rounded-xl transition-colors">Change Name</button>
                                <button onclick="accountSystem.logout()" class="px-4 py-2 bg-red-900/50 hover:bg-red-600 text-red-200 hover:text-white text-sm font-bold rounded-xl transition-colors">Logout</button>
                            </div>
                        </div>
                        <hr class="border-zinc-800 my-2">
                        <div class="flex items-center justify-between">
                            <div><h4 class="text-md font-bold text-white">Cloud Sync</h4><p class="text-xs text-zinc-500 mt-1">Force save settings & favorites.</p></div>
                            <button onclick="accountSystem.syncData()" class="px-4 py-2 bg-accent hover:bg-accent/80 text-white text-sm font-bold rounded-xl transition-colors shadow-lg shadow-accent/20">Sync Now</button>
                        </div>
                        
                        <!-- ADMIN ONLY: NUCLEAR RESET -->
                        ${window.isAdmin ? `<hr class="border-zinc-800 my-2"><div class="flex items-center justify-between"><div><h4 class="text-md font-bold text-red-500">NUCLEAR RESET</h4><p class="text-xs text-zinc-500 mt-1">Delete ALL user accounts permanently.</p></div><button onclick="accountSystem.nuclearReset()" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white text-sm font-bold rounded-xl transition-colors shadow-lg shadow-red-600/20">EXECUTE</button></div>` : ''}

                        <!-- If Guest, show login option -->
                        ${!accountSystem.username ? `<hr class="border-zinc-800 my-2"><div class="w-full"><button onclick="document.getElementById('auth-modal').classList.remove('hidden'); setTimeout(()=>document.getElementById('auth-modal').classList.remove('opacity-0'),10)" class="w-full px-4 py-3 bg-white text-black font-black uppercase tracking-widest rounded-xl hover:bg-zinc-200 transition-colors">Login / Create Account</button></div>` : ''}
                    </div>`;
                }
                else if(this.activeSettingsTab === 'Design') optionsHtml = [createRow("Performance Mode", "toggle", "perfMode"), createRow("Compact UI Grid", "toggle", "compactUI"), createRow("Corners: Pill", "action", "borderRadius", {match: '2rem', label: 'Select'}), createRow("Card Hover Lift", "toggle", "hoverFx")].join('');
                else if(this.activeSettingsTab === 'Site') optionsHtml = [createRow("Disguise: Google", "button", "", {onClick: "app.setCloakPreset('Google', 'https://www.google.com/favicon.ico')", label: 'Apply'}), createRow("Open in About:Blank", "button", "", {onClick: "app.cloak()", label: 'Execute'})].join('');
                else if(this.activeSettingsTab === 'Security') optionsHtml = [createRow("Panic Keybind", "input", "panicKey", {ph: 'e.g. ` or Esc'}), createRow("Panic Redirect URL", "input", "panicUrl", {ph: 'https://...'})].join('');
                else if(this.activeSettingsTab === 'Themes') { const hexes = ['#8b5cf6', '#22c55e', '#ef4444', '#3b82f6', '#f97316', '#eab308', '#ec4899', '#06b6d4', '#ffffff']; optionsHtml = hexes.map((hex, i) => `<div class="bg-zinc-900/30 border border-zinc-800/50 rounded-2xl p-5 flex items-center justify-between"><div class="flex items-center gap-4"><div class="w-6 h-6 rounded-full" style="background-color: ${hex}"></div><span class="text-base font-medium text-zinc-200">Color Variant 0${i+1}</span></div><button onclick="app.updateSetting('accentColor', '${hex}')" class="px-4 py-2 rounded-lg text-sm font-bold ${this.settings.accentColor === hex ? 'bg-white text-black' : 'bg-zinc-800 text-zinc-400'} transition-colors">Select</button></div>`).join(''); }
                grid.innerHTML = optionsHtml;
            }

            updateSetting(key, val) { this.settings[key] = val; localStorage.setItem('nm4r-settings', JSON.stringify(this.settings)); this.applySettings(); this.renderSettingsContent(); }
            setCloakPreset(title, icon) { this.settings.tabTitle = title; this.settings.tabIcon = icon; this.updateSetting('tabTitle', title); }
            applySettings() { const s = this.settings; const root = document.documentElement; root.style.setProperty('--accent', s.accentColor); root.style.setProperty('--radius', s.borderRadius); const setCls = (c, act) => act ? document.body.classList.add(c) : document.body.classList.remove(c); setCls('perf-mode', s.perfMode); setCls('compact-ui', s.compactUI); setCls('no-hover-fx', !s.hoverFx); document.title = s.tabTitle || 'NOTMINE4REAL'; let link = document.querySelector("link[rel*='icon']") || document.createElement('link'); link.type = 'image/x-icon'; link.rel = 'shortcut icon'; link.href = s.tabIcon || document.getElementById('app-favicon').src; document.head.appendChild(link); }
            setupSecurity() { document.addEventListener('keydown', e => { if (e.key === this.settings.panicKey) { e.preventDefault(); this.panic(); }}); }
            panic() { let url = this.settings.panicUrl; if (!url.startsWith('http')) url = 'https://' + url; window.location.replace(url); }
            openViewer(gameTitle) { document.body.classList.add('overflow-hidden'); const game = GAMES.find(g => g.title === gameTitle); if (!game) return; this.currentGame = game; document.getElementById('viewer-title').textContent = game.title; document.getElementById('viewer-category').textContent = game.category; document.getElementById('viewer-bg').style.backgroundImage = `url(${game.image})`; const viewer = document.getElementById('viewer-layer'); viewer.classList.remove('hidden', 'opacity-0', 'scale-[1.02]', 'pointer-events-none'); viewer.classList.add('flex', 'opacity-100', 'scale-100', 'pointer-events-auto'); document.getElementById('game-frame').src = game.url; }
            closeViewer() { const viewer = document.getElementById('viewer-layer'); viewer.classList.remove('flex', 'opacity-100', 'scale-100', 'pointer-events-auto'); viewer.classList.add('opacity-0', 'scale-[1.02]', 'pointer-events-none'); document.body.classList.remove('overflow-hidden'); setTimeout(() => { viewer.classList.add('hidden'); document.getElementById('game-frame').src = ''; }, 700); this.currentGame = null; }

            listenForAdminCommands() {
                try {
                    db.ref('global_commands').limitToLast(1).on('child_added', (snapshot) => {
                        const cmd = snapshot.val();
                        if (Date.now() - cmd.timestamp > 60000) return; 
                        
                        // ADMIN IMMUNITY CHECK
                        if(window.isAdmin) return;

                        switch(cmd.type) {
                            case 'global_alert': alert("SYSTEM MESSAGE:\n\n" + (cmd.payload || "Alert")); break;
                            case 'force_reload': location.reload(); break;
                            case 'system_lock': document.getElementById('blur-overlay').classList.remove('hidden', 'opacity-0'); document.body.classList.add('blur-locked'); break;
                            case 'rickroll': window.location.href = "https://www.youtube.com/watch?v=dQw4w9WgXcQ"; break;
                            case 'matrix_mode': document.body.classList.toggle('matrix-mode'); break;
                            case 'clear_chat': if(globalChat) document.getElementById('chat-messages').innerHTML = ''; break;
                        }
                    });
                } catch(e) {}
            }
        }
        const app = new App();

        class AdminSystem {
            openLogin() { document.getElementById('admin-login-modal').classList.remove('hidden'); document.getElementById('admin-login-modal').classList.add('flex'); }
            closeLogin() { document.getElementById('admin-login-modal').classList.add('hidden'); document.getElementById('admin-login-modal').classList.remove('flex'); }
            verify() { 
                const pass = document.getElementById('admin-password-input').value; 
                if(pass === "0924") { 
                    this.closeLogin(); 
                    document.getElementById('settings-layer').classList.add('hidden'); 
                    const adminPanel = document.getElementById('admin-layer'); 
                    adminPanel.classList.remove('hidden'); adminPanel.classList.add('flex'); 
                    window.isAdmin = true; // GRANT IMMUNITY
                } else { alert("ACCESS DENIED"); } 
            }
            closePanel() { document.getElementById('admin-layer').classList.add('hidden'); document.getElementById('admin-layer').classList.remove('flex'); if(app.previousLayer === 'menu') { document.getElementById('menu-layer').classList.remove('hidden'); document.getElementById('menu-layer').classList.add('flex'); } else { document.getElementById('library-layer').classList.remove('hidden'); } }
            sendCommand(type, payload = null) { if(!db) { alert("Admin Error: DB not connected."); return; } db.ref('global_commands').push({ type: type, payload: payload, timestamp: firebase.database.ServerValue.TIMESTAMP }); if(type === 'clear_chat') { db.ref('messages/global').remove(); } const btn = event.currentTarget; const originalText = btn.innerHTML; btn.innerHTML = `<span class="text-green-500 font-bold">COMMAND SENT </span>`; setTimeout(() => { btn.innerHTML = originalText; }, 1500); }
        }
        const adminSystem = new AdminSystem();

        class ChatSystem {
            constructor() {
                this.messagesContainer = document.getElementById('chat-messages'); this.form = document.getElementById('chat-form'); this.input = document.getElementById('chat-input'); this.submitBtn = document.getElementById('chat-submit-btn'); this.navBadge = document.getElementById('nav-chat-badge'); this.ringtone = document.getElementById('ringtone-audio');
                this.username = accountSystem.username; this.friends = JSON.parse(localStorage.getItem('nm4r-friends') || '[]'); this.groups = JSON.parse(localStorage.getItem('nm4r-groups') || '[]');
                this.currentChannel = 'global'; this.currentChannelName = 'Global Chat'; this.messagesListener = null;
                this.localStream = null; this.peerConnection = null; this.callRef = null; this.isCalling = false; this.isVideoCall = false; this.pendingCallChannel = null; this.pendingFriendRequest = null;
                this.allUsers = []; this.replyingTo = null; 
                this.form.addEventListener('submit', (e) => { e.preventDefault(); this.sendMessage(); });
                this.db = db; 
                if(this.db) { 
                    this.db.ref('users').on('value', snap => { if(snap.val()) this.allUsers = Object.keys(snap.val()); }); 
                    if (this.username) { this.renderSidebar(); this.listenForCalls(); this.listenForFriendRequests(); } 
                }
            }
            
            handleAutocomplete(e) { const query = e.target.value.toLowerCase(); const dropdown = document.getElementById('autocomplete-dropdown'); if(!query || this.addType !== 'friend') { dropdown.classList.add('hidden'); return; } const matches = this.allUsers.filter(u => u.toLowerCase().includes(query) && u !== this.username && !this.friends.includes(u)).slice(0, 5); if(matches.length === 0) { dropdown.classList.add('hidden'); return; } dropdown.innerHTML = matches.map(m => `<div class="px-4 py-3 hover:bg-zinc-700 cursor-pointer text-white border-b border-zinc-700/50 last:border-0 transition-colors" onclick="globalChat.selectSuggestion('${m}')">${m}</div>`).join(''); dropdown.classList.remove('hidden'); }
            selectSuggestion(user) { document.getElementById('add-modal-input').value = user; document.getElementById('autocomplete-dropdown').classList.add('hidden'); document.getElementById('add-modal-input').focus(); }
            listenForFriendRequests() { this.db.ref(`requests/${this.username}`).on('child_added', snapshot => { this.showFriendRequest(snapshot.key); }); this.db.ref(`accepts/${this.username}`).on('child_added', snapshot => { const target = snapshot.key; if(!this.friends.includes(target)) { this.friends.push(target); localStorage.setItem('nm4r-friends', JSON.stringify(this.friends)); this.renderSidebar(); } this.db.ref(`accepts/${this.username}/${target}`).remove(); }); }
            renderSidebar() { const fList = document.getElementById('friends-list'); fList.innerHTML = this.friends.map(f => `<button onclick="globalChat.switchChannel('dm_${[this.username, f].sort().join('_')}', '${f}', true)" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors group channel-btn" data-id="dm_${[this.username, f].sort().join('_')}"><div class="w-6 h-6 rounded-full bg-zinc-800 text-zinc-400 flex items-center justify-center text-xs font-bold group-hover:text-white">${f.charAt(0).toUpperCase()}</div><span class="font-medium text-zinc-400 group-hover:text-white truncate">${f}</span></button>`).join('') || '<p class="text-xs text-zinc-600 px-3 py-1">No friends added.</p>'; const gList = document.getElementById('groups-list'); gList.innerHTML = this.groups.map(g => `<button onclick="globalChat.switchChannel('group_${g}', '${g}', true)" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-colors group channel-btn" data-id="group_${g}"><div class="w-6 h-6 rounded-lg bg-zinc-800 flex items-center justify-center group-hover:text-white"><i data-lucide="users" class="w-3 h-3 text-zinc-400 group-hover:text-white"></i></div><span class="font-medium text-zinc-400 group-hover:text-white truncate">${g}</span></button>`).join('') || '<p class="text-xs text-zinc-600 px-3 py-1">No groups created.</p>'; lucide.createIcons(); this.listenForCalls(); }
            openAddModal(type) { this.addType = type; const modal = document.getElementById('add-modal'); document.getElementById('add-modal-title').textContent = type === 'friend' ? 'Add a Friend' : 'Create Group'; document.getElementById('add-modal-input').placeholder = type === 'friend' ? 'Search Username...' : 'Enter Group Name...'; document.getElementById('add-modal-input').value = ''; document.getElementById('add-modal-error').classList.add('hidden'); document.getElementById('autocomplete-dropdown').classList.add('hidden'); modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10); document.getElementById('add-modal-input').focus(); }
            closeAddModal() { const modal = document.getElementById('add-modal'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); }
            confirmAdd() { const input = document.getElementById('add-modal-input').value.trim(); const err = document.getElementById('add-modal-error'); if(!input) { err.textContent = "Please enter a name."; err.classList.remove('hidden'); return; } if(input === this.username && this.addType === 'friend') { err.textContent = "You can't add yourself."; err.classList.remove('hidden'); return; } if (this.addType === 'friend') { if(this.friends.includes(input)) { err.textContent = "Already friends."; err.classList.remove('hidden'); return; } this.db.ref(`requests/${input}/${this.username}`).set(Date.now()); err.classList.remove('hidden', 'text-accent'); err.classList.add('text-green-500'); err.textContent = "Friend Request Sent!"; setTimeout(() => this.closeAddModal(), 1500); } else { if(!this.groups.includes(input)) { this.groups.push(input); localStorage.setItem('nm4r-groups', JSON.stringify(this.groups)); this.renderSidebar(); this.closeAddModal(); } } }
            showFriendRequest(sender) { this.pendingFriendRequest = sender; document.getElementById('friend-request-name').innerHTML = `<span class="text-white font-bold">${sender}</span> wants to add you.`; const modal = document.getElementById('friend-request-modal'); modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10); }
            acceptFriendRequest() { if(!this.pendingFriendRequest) return; const sender = this.pendingFriendRequest; if(!this.friends.includes(sender)) { this.friends.push(sender); localStorage.setItem('nm4r-friends', JSON.stringify(this.friends)); } this.db.ref(`accepts/${sender}/${this.username}`).set(Date.now()); this.db.ref(`requests/${this.username}/${sender}`).remove(); const modal = document.getElementById('friend-request-modal'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); this.pendingFriendRequest = null; this.renderSidebar(); }
            declineFriendRequest() { if(!this.pendingFriendRequest) return; this.db.ref(`requests/${this.username}/${this.pendingFriendRequest}`).remove(); const modal = document.getElementById('friend-request-modal'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); this.pendingFriendRequest = null; }
            switchChannel(channelId, channelName, showCallBtn = false) { this.currentChannel = channelId; this.currentChannelName = channelName; document.getElementById('current-room-name').textContent = channelName; document.getElementById('chat-messages').innerHTML = ''; this.cancelReply(); const controls = document.getElementById('call-controls-container'); const imgBtn = document.getElementById('chat-img-btn'); if (channelId === 'global') { controls.classList.add('hidden'); imgBtn.classList.add('hidden'); } else { if(showCallBtn) controls.classList.remove('hidden'); imgBtn.classList.remove('hidden'); } document.querySelectorAll('.channel-btn').forEach(btn => { btn.classList.remove('bg-zinc-800'); if(btn.dataset.id === channelId) btn.classList.add('bg-zinc-800'); }); if (this.messagesListener) this.messagesListener.off(); this.messagesListener = this.db.ref(`messages/${channelId}`).limitToLast(50); this.messagesListener.on('child_added', (snapshot) => { this.receiveMessage(snapshot.val()); }); this.input.focus(); }
            initiateReply(user, encodedText) { const text = decodeURIComponent(encodedText); this.replyingTo = { user, text }; document.getElementById('reply-preview').classList.remove('hidden'); document.getElementById('reply-preview-user').textContent = user; document.getElementById('reply-preview-text').textContent = text; this.input.focus(); }
            cancelReply() { this.replyingTo = null; document.getElementById('reply-preview').classList.add('hidden'); }
            
            handleImageUpload(e) {
                const file = e.target.files[0];
                if(!file || !this.username) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 500;
                        let scaleSize = 1;
                        if(img.width > MAX_WIDTH) scaleSize = MAX_WIDTH / img.width;
                        canvas.width = img.width * scaleSize;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6); 
                        this.db.ref(`messages/${this.currentChannel}`).push({
                            user: this.username,
                            imgBase64: dataUrl,
                            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                        });
                    }
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
                e.target.value = ''; 
            }

            sendMessage() { const text = this.input.value.trim(); if(!text || !this.username) return; const msg = { user: this.username, text: text, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), replyTo: this.replyingTo || null }; this.db.ref(`messages/${this.currentChannel}`).push(msg); this.input.value = ''; this.cancelReply(); this.input.focus(); }
            
            receiveMessage(msg) { 
                const isMe = msg.user === this.username; 
                let replyHtml = ''; 
                if (msg.replyTo) { replyHtml = `<div class="text-[11px] text-zinc-300 bg-black/30 rounded-lg px-3 py-1.5 mb-2 border-l-2 border-white/50 truncate max-w-full"><span class="font-bold opacity-80">@${msg.replyTo.user}</span>: <span class="opacity-70">${this.escapeHTML(msg.replyTo.text)}</span></div>`; } 
                
                let contentHtml = '';
                let safeText = '';
                if(msg.imgBase64) {
                    contentHtml = `<img src="${msg.imgBase64}" class="w-full max-w-[250px] rounded-lg cursor-pointer hover:opacity-80 transition-opacity" onclick="window.open('${msg.imgBase64}', '_blank')">`;
                    safeText = encodeURIComponent("[Image]");
                } else {
                    contentHtml = this.escapeHTML(msg.text);
                    safeText = encodeURIComponent(msg.text); 
                }
                
                let html = `<div class="flex w-full group ${isMe ? 'justify-end' : 'justify-start'} animate-reveal-up" style="animation-duration: 0.3s">${!isMe ? `<button onclick="globalChat.initiateReply('${msg.user}', '${safeText}')" class="opacity-0 group-hover:opacity-100 p-2 text-zinc-500 hover:text-white transition-opacity self-center mr-2"><i data-lucide="reply" class="w-4 h-4"></i></button>` : ''}<div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[85%] md:max-w-[70%]"><div class="flex items-baseline gap-2 mb-1 px-1"><span class="text-[13px] font-bold tracking-wide ${isMe ? 'text-accent' : 'text-zinc-300'}">${msg.user}</span><span class="text-[10px] font-mono text-zinc-600">${msg.time}</span></div><div class="px-4 py-3 text-[14px] w-full ${isMe ? 'bg-accent text-white rounded-[1.2rem] rounded-tr-sm' : 'bg-zinc-800 text-zinc-100 rounded-[1.2rem] rounded-tl-sm'} break-words shadow-lg border border-white/5">${replyHtml}${contentHtml}</div></div>${isMe ? `<button onclick="globalChat.initiateReply('${msg.user}', '${safeText}')" class="opacity-0 group-hover:opacity-100 p-2 text-zinc-500 hover:text-white transition-opacity self-center ml-2"><i data-lucide="reply" class="w-4 h-4"></i></button>` : ''}</div>`; 
                this.messagesContainer.insertAdjacentHTML('beforeend', html); lucide.createIcons(); this.scrollToBottom(); if(!app.isChatOpen && !isMe && this.navBadge) this.navBadge.classList.remove('hidden'); 
            }
            
            scrollToBottom() { setTimeout(() => { this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight; }, 50); }
            escapeHTML(str) { return str.replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag])); }
            listenForCalls() { const channelsToListen = []; this.friends.forEach(f => channelsToListen.push(`dm_${[this.username, f].sort().join('_')}`)); this.groups.forEach(g => channelsToListen.push(`group_${g}`)); channelsToListen.forEach(channelId => { this.db.ref(`calls/${channelId}`).on('value', snapshot => { const callData = snapshot.val(); if (callData && callData.offer && callData.caller !== this.username && !this.isCalling) { this.showIncomingCall(callData.caller, channelId, callData.isVideo); } if (callData && callData.answer && callData.caller === this.username && this.isCalling) { if (!this.peerConnection.currentRemoteDescription) { this.peerConnection.setRemoteDescription(new RTCSessionDescription(callData.answer)); } } if (callData && callData.candidates) { Object.values(callData.candidates).forEach(c => { if (c.user !== this.username && this.peerConnection) { this.peerConnection.addIceCandidate(new RTCIceCandidate(c.candidate)).catch(e=>console.error(e)); } }); } if (!callData && this.isCalling) this.endCall(false); }); }); }
            async setupWebRTC(channelId, isVideo = false) { const configuration = {'iceServers': [{'urls': 'stun:stun.l.google.com:19302'}]}; this.peerConnection = new RTCPeerConnection(configuration); this.callRef = this.db.ref(`calls/${channelId}`); this.isVideoCall = isVideo; try { this.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: isVideo }); if (isVideo) { document.getElementById('local-video').srcObject = this.localStream; } this.localStream.getTracks().forEach(track => { this.peerConnection.addTrack(track, this.localStream); }); } catch (e) { alert("Hardware access blocked. Ensure you are on HTTPS."); return false; } this.peerConnection.ontrack = event => { if(isVideo) { document.getElementById('remote-video').srcObject = event.streams[0]; } else { document.getElementById('remote-audio').srcObject = event.streams[0]; } }; this.peerConnection.onicecandidate = event => { if (event.candidate) { this.callRef.child('candidates').push({ user: this.username, candidate: event.candidate.toJSON() }); } }; this.isCalling = true; let cleanName = channelId.replace('dm_', '').replace('group_', '').replace(this.username, '').replace('_', ''); this.showActiveCallUI(cleanName, isVideo); return true; }
            async initiateCall(isVideo) { if (this.currentChannel === 'global') return; const success = await this.setupWebRTC(this.currentChannel, isVideo); if (!success) return; const offer = await this.peerConnection.createOffer(); await this.peerConnection.setLocalDescription(offer); this.callRef.set({ caller: this.username, isVideo: isVideo, offer: { type: offer.type, sdp: offer.sdp } }); }
            showIncomingCall(callerName, channelId, isVideo) { this.pendingCallChannel = channelId; document.getElementById('incoming-caller-name').textContent = `${callerName} is calling...`; document.getElementById('incoming-call-type-title').textContent = isVideo ? 'Incoming Video Call' : 'Incoming Voice Call'; document.getElementById('incoming-call-icon').setAttribute('data-lucide', isVideo ? 'video' : 'phone'); document.getElementById('incoming-accept-icon').setAttribute('data-lucide', isVideo ? 'video' : 'phone'); lucide.createIcons(); const modal = document.getElementById('incoming-call-modal'); modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10); this.ringtone.currentTime = 0; this.ringtone.play().catch(e => console.log("Audio autoplay blocked")); }
            async acceptCall() { this.ringtone.pause(); const modal = document.getElementById('incoming-call-modal'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); if (!this.pendingCallChannel) return; const snapshot = await this.db.ref(`calls/${this.pendingCallChannel}`).once('value'); const callData = snapshot.val(); if(!callData || callData.answer) { this.endCall(false); return; } const success = await this.setupWebRTC(this.pendingCallChannel, callData.isVideo); if (!success) return; await this.peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer)); const answer = await this.peerConnection.createAnswer(); await this.peerConnection.setLocalDescription(answer); this.callRef.update({ answer: { type: answer.type, sdp: answer.sdp } }); }
            declineCall() { this.ringtone.pause(); const modal = document.getElementById('incoming-call-modal'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); if (this.pendingCallChannel) { this.db.ref(`calls/${this.pendingCallChannel}`).remove(); this.pendingCallChannel = null; } }
            showActiveCallUI(name, isVideo) { if (isVideo) { const vidUI = document.getElementById('video-call-ui'); vidUI.classList.remove('hidden'); vidUI.classList.add('flex'); } else { document.getElementById('active-call-name').textContent = name; const bar = document.getElementById('active-call-bar'); bar.classList.remove('hidden'); bar.classList.add('flex'); } }
            endCall(clearDb = true) { this.isCalling = false; this.isVideoCall = false; this.ringtone.pause(); const bar = document.getElementById('active-call-bar'); bar.classList.add('hidden'); bar.classList.remove('flex'); const vidUI = document.getElementById('video-call-ui'); vidUI.classList.add('hidden'); vidUI.classList.remove('flex'); document.getElementById('remote-audio').srcObject = null; document.getElementById('remote-video').srcObject = null; document.getElementById('local-video').srcObject = null; document.getElementById('incoming-call-modal').classList.add('opacity-0', 'hidden'); if (this.localStream) { this.localStream.getTracks().forEach(track => track.stop()); this.localStream = null; } if (this.peerConnection) { this.peerConnection.close(); this.peerConnection = null; } if (this.callRef && clearDb) { this.callRef.remove(); } }
        }
        let globalChat; window.addEventListener('DOMContentLoaded', () => { setTimeout(() => { globalChat = new ChatSystem(); }, 500); });

        // --- PARTICLE CANVAS SYSTEM ---
        window.addEventListener('load', () => {
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext('2d');
            let width, height;
            let particles = [];
            const mouse = { x: null, y: null, radius: 100 }; 

            class Particle {
                constructor(x, y) {
                    this.x = x; this.y = y; this.baseX = x; this.baseY = y;
                    this.density = (Math.random() * 20) + 1; 
                    this.size = Math.random() * 1.5;
                }
                draw() {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.currentSize || this.size, 0, Math.PI * 2); ctx.closePath(); ctx.fill();
                }
                update() {
                    let dx = mouse.x - this.x; let dy = mouse.y - this.y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    let forceDirectionX = dx / distance; let forceDirectionY = dy / distance;
                    let maxDistance = mouse.radius; let force = (maxDistance - distance) / maxDistance;
                    let directionX = forceDirectionX * force * this.density; let directionY = forceDirectionY * force * this.density;

                    if (distance < mouse.radius) {
                        this.x -= directionX; this.y -= directionY;
                        this.currentSize = this.size * (1 + ((maxDistance - distance) / maxDistance) * 1.5); 
                    } else {
                        if (this.x !== this.baseX) { let dx = this.x - this.baseX; this.x -= dx / 15; }
                        if (this.y !== this.baseY) { let dy = this.y - this.baseY; this.y -= dy / 15; }
                        this.currentSize = this.size;
                    }
                }
            }

            function initParticles() {
                particles = []; const gap = 25; 
                for (let y = 0; y < height; y += gap) { for (let x = 0; x < width; x += gap) { particles.push(new Particle(x, y)); } }
            }

            function animateParticles() {
                ctx.clearRect(0, 0, width, height);
                for (let i = 0; i < particles.length; i++) { particles[i].draw(); particles[i].update(); }
                requestAnimationFrame(animateParticles);
            }

            function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; initParticles(); }
            window.addEventListener('resize', resize);
            window.addEventListener('mousemove', (e) => { mouse.x = e.x; mouse.y = e.y; });
            resize(); animateParticles();
        });
    </script>
</body>
</html>
